<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ars Magna: The Digital Alchemist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    /* ... (CSS Anda dari sebelumnya, tidak perlu diubah, biarkan saja) ... */
    .glass-effect { background: rgba(10, 5, 20, 0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); }
    @keyframes glowing { 0% { box-shadow: 0 0 5px #a855f7; } 50% { box-shadow: 0 0 20px #a855f7, 0 0 30px #a855f7; } 100% { box-shadow: 0 0 5px #a855f7; } }
    .glowing-btn { animation: glowing 3s infinite; }
    @keyframes fadeInScale { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
    .new-discovery { animation: fadeInScale 0.5s ease-out; }
    .font-cinzel { font-family: 'Cinzel', serif; }
    .font-quicksand { font-family: 'Quicksand', sans-serif; }
  </style>
  
  <script>
    tailwind.config = { /* ... (Config Tailwind Anda, biarkan saja) ... */ };
  </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-gray-200 font-quicksand">
  <div class="max-w-md mx-auto p-4 min-h-screen flex flex-col justify-center">

    <!-- ... (Seluruh bagian HTML Anda untuk Judul, Login, Register, dan Dashboard, TIDAK PERLU DIUBAH) ... -->
    <!-- JUDUL -->
    <div class="text-center mb-6"> <h1 class="text-4xl font-bold text-white font-cinzel tracking-widest">Ars Magna</h1> <p class="text-purple-300/80">The Digital Alchemist</p> </div>
    <!-- LOGIN -->
    <div id="loginSection" class="glass-effect p-6 text-white"> <h2 class="text-2xl font-semibold mb-4 text-center font-cinzel">Login Alchemist</h2> <input type="email" id="email" placeholder="Ancient Scroll (Email)" class="w-full p-3 mb-3 bg-white/10 border-none rounded-lg placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-primary" /> <input type="password" id="password" placeholder="Secret Word (Password)" class="w-full p-3 mb-4 bg-white/10 border-none rounded-lg placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-primary" /> <button onclick="login()" class="bg-primary text-white px-4 py-3 rounded-lg w-full font-bold hover:bg-purple-600 transition-all">Enter Laboratory</button> <p class="text-sm text-center mt-4">Not yet an apprentice? <a href="#" onclick="toggleRegister()" class="font-bold underline text-secondary">Begin your journey here</a></p> </div>
    <!-- REGISTER -->
    <div id="registerSection" class="glass-effect p-6 text-white hidden"> <h2 class="text-2xl font-semibold mb-4 text-center font-cinzel">Register Apprentice</h2> <input type="email" id="regEmail" placeholder="Your Scroll (Email)" class="w-full p-3 mb-3 bg-white/10 border-none rounded-lg placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-primary" /> <input type="password" id="regPassword" placeholder="Your Secret Word (Password)" class="w-full p-3 mb-4 bg-white/10 border-none rounded-lg placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-primary" /> <button onclick="register()" class="bg-primary text-white px-4 py-3 rounded-lg w-full font-bold hover:bg-purple-600 transition-all">Register</button> <p class="text-sm text-center mt-4">Already have a lab? <a href="#" onclick="toggleLogin()" class="font-bold underline text-secondary">Enter here</a></p> </div>
    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden space-y-4"> <div class="glass-effect p-4 flex justify-between items-center text-white"> <div> <p class="text-lg font-semibold">Alchemist, <span id="username" class="font-cinzel"></span></p> <p>Level: <span id="level" class="font-bold text-secondary">1</span></p> <p>Mana: <span id="mana" class="font-bold text-blue-300">100</span> / <span id="maxMana">100</span></p> </div> <button onclick="logout()" class="text-red-400 font-semibold hover:text-red-300 transition-all">Leave Lab</button> </div>
    <!-- DONASI -->
    <div id="donationSection" class="glass-effect p-4 text-white">
        <h2 class="text-xl font-semibold mb-2 font-cinzel">Esoteric Shop</h2>
        <p class="text-sm text-white/70 mb-2">Dukung kreator untuk mendapatkan Mana tambahan.</p>
        <button onclick="showDonationInfo()" class="bg-yellow-500 text-gray-900 px-4 py-2 rounded-lg w-full font-bold hover:bg-yellow-400 transition-all mb-3">Donasi Sekarang</button>
        
        <div class="mt-4 border-t border-white/20 pt-3">
          <input type="text" id="redeemInput" placeholder="Masukkan Kode Redeem Mana" class="w-full p-3 bg-white/10 border-none rounded-lg placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-primary">
          <button onclick="redeemManaCode()" class="bg-primary text-white px-4 py-2 mt-2 rounded-lg w-full font-bold hover:bg-purple-600 transition-all">Redeem Kode</button>
        </div>
      </div>
      
      <div id="donationInfo" class="glass-effect p-4 text-white hidden">    <!-- MEJA KOMBINASI -->
    <div class="glass-effect p-4 text-white"> <h2 class="text-xl font-semibold mb-2 font-cinzel">Combination Table</h2> <div class="flex items-center justify-center space-x-2"> <select id="elemen1" class="w-full p-3 bg-white/10 border-none rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></select> <span class="text-2xl font-bold text-secondary">+</span> <select id="elemen2" class="w-full p-3 bg-white/10 border-none rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></select> </div> <div id="elemen3Container" class="hidden mt-2 flex items-center justify-center space-x-2"> <span class="text-2xl font-bold text-secondary">+</span> <select id="elemen3" class="w-full p-3 bg-white/10 border-none rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></select> </div> <button onclick="combineElements()" class="bg-primary text-white px-4 py-3 rounded-lg w-full font-bold mt-4 glowing-btn">COMBINE (-10 Mana)</button> </div>
    <!-- GRIMOIRE -->
    <div class="glass-effect p-4 text-white"> <h2 class="text-xl font-semibold mb-2 font-cinzel">Grimoire</h2> <ul id="grimoire" class="text-sm space-y-2 h-48 overflow-y-auto pr-2"> <li class="text-white/50">Your Grimoire is empty. Begin experimenting.</li> </ul> </div> </div>

  </div>

<!-- MEMANGGIL DATABASE BARU KITA -->
<script src="database.js"></script>

<script>
  let userData = JSON.parse(localStorage.getItem("alchemistData") || "{}");
  let currentUser = null;
  
  function toggleRegister() { document.getElementById("loginSection").classList.add("hidden"); document.getElementById("registerSection").classList.remove("hidden"); }
  function toggleLogin() { document.getElementById("registerSection").classList.add("hidden"); document.getElementById("loginSection").classList.remove("hidden"); }
  function register() { const email = document.getElementById("regEmail").value; const password = document.getElementById("regPassword").value; if (!email || !password) return alert("Scroll and Secret Word cannot be empty!"); if (userData[email]) return alert("This scroll is already claimed by another alchemist!"); userData[email] = { password, level: 1, mana: 100, maxMana: 100, grimoire: [], discovered: ["Api", "Air", "Tanah", "Udara"] }; localStorage.setItem("alchemistData", JSON.stringify(userData)); alert("Apprenticeship successful. Please enter your laboratory."); toggleLogin(); }
  
  // FUNGSI LOGIN YANG SUDAH DIMODIFIKASI
  function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    if (userData[email] && userData[email].password === password) {
      currentUser = email;
      // MENYIMPAN SESI LOGIN
      localStorage.setItem("lastAlchemistSession", currentUser);
      loadDashboard();
    } else {
      alert("Login failed! The ancient scrolls do not recognize you.");
    }
  }

  function loadDashboard() { document.getElementById("loginSection").classList.add("hidden"); document.getElementById("registerSection").classList.add("hidden"); document.getElementById("dashboard").classList.remove("hidden"); document.getElementById("username").innerText = currentUser.split('@')[0]; updateUI(); }
  function updateUI() { updateMana(); updateLevel(); updateGrimoire(); populateSelectors(); }

  // FUNGSI LOGOUT YANG SUDAH DIMODIFIKASI
  function logout() {
    currentUser = null;
    // MENGHAPUS SESI LOGIN
    localStorage.removeItem("lastAlchemistSession");
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("loginSection").classList.remove("hidden");
    hideDonationInfo();
  }

  function updateMana() { const user = userData[currentUser]; document.getElementById("mana").innerText = user.mana; document.getElementById("maxMana").innerText = user.maxMana; }
  function updateLevel() { const user = userData[currentUser]; document.getElementById("level").innerText = user.level; if(user.level >= 3) { document.getElementById("elemen3Container").classList.remove("hidden"); } else { document.getElementById("elemen3Container").classList.add("hidden"); } }
  function updateGrimoire() { const grimoire = userData[currentUser]?.grimoire || []; const grimoireEl = document.getElementById("grimoire"); grimoireEl.innerHTML = ""; if (grimoire.length === 0) { grimoireEl.innerHTML = "<li class='text-white/50'>Your Grimoire is empty. Begin experimenting.</li>"; } else { grimoire.slice().reverse().forEach(entry => { const li = document.createElement("li"); li.className = `p-2 rounded-md ${entry.success ? 'bg-green-500/20' : 'bg-red-500/20'}`; if(entry.isNew) li.classList.add('new-discovery'); li.innerHTML = `${entry.success ? '✅' : '❌'} ${entry.recipe} ${entry.success ? `-> <span class="font-bold text-secondary">${entry.result}</span>` : ''}`; grimoireEl.appendChild(li); }); } }
  function populateSelectors() { const discovered = userData[currentUser]?.discovered || []; const selectors = [document.getElementById("elemen1"), document.getElementById("elemen2"), document.getElementById("elemen3")]; selectors.forEach(selector => { selector.innerHTML = ""; discovered.forEach(el => { const option = document.createElement("option"); option.value = el; option.innerText = el; selector.appendChild(option); }); }); }
  function showDonationInfo() { document.getElementById("donationSection").classList.add("hidden"); document.getElementById("donationInfo").classList.remove("hidden"); }
  function hideDonationInfo() { document.getElementById("donationInfo").classList.add("hidden"); document.getElementById("donationSection").classList.remove("hidden"); }

  function combineElements() {
      const user = userData[currentUser];
      const cost = 10;
      if (user.mana < cost) {
          alert("Not enough Mana! Rest or visit the Esoteric Shop.");
          return;
      }
      user.mana -= cost;
      const e1 = document.getElementById("elemen1").value;
      const e2 = document.getElementById("elemen2").value;
      const elements = [e1, e2].sort();
      let recipeKey = elements.join('+');
      let result = null;
      if(user.level >= 3 && !document.getElementById('elemen3Container').classList.contains('hidden')){
        const e3 = document.getElementById("elemen3").value;
        const threeElements = [e1, e2, e3].sort();
        recipeKey = threeElements.join('+');
      }
      result = recipes[recipeKey] || specialRecipes[recipeKey];
      let isNewDiscovery = false;
      if (result) {
        if (!user.discovered.includes(result)) {
          user.discovered.push(result);
          isNewDiscovery = true;
          alert(`✨ DISCOVERY! ✨\nYou have successfully created: ${result}!`);
          const discoveriesCount = user.discovered.length - 4;
          if (user.level === 1 && discoveriesCount >= 7) {
              user.level = 2;
              user.maxMana += 50;
              alert("LEVEL UP! You are now a Level 2 Alchemist. Your Max Mana has increased!");
          }
          if (user.level === 2 && discoveriesCount >= 15) {
              user.level = 3;
              user.maxMana += 50;
              alert("LEVEL UP! You are now a MASTER ALCHEMIST (Level 3)! You can now combine THREE elements!");
          }
        }
        user.grimoire.push({ recipe: recipeKey.replace(/\+/g, ' + '), result, success: true, isNew: isNewDiscovery });
      } else {
        user.grimoire.push({ recipe: recipeKey.replace(/\+/g, ' + '), success: false });
      }
      localStorage.setItem("alchemistData", JSON.stringify(userData));
      updateUI();
  }

    // FUNGSI BARU UNTUK REDEEM KODE
  function redeemManaCode() {
    const code = document.getElementById("redeemInput").value;
    if (!code) return alert("Masukkan kode redeem terlebih dahulu.");

    const user = userData[currentUser];
    
    // 1. Cek apakah kode ini sudah pernah dipakai
    if (user.usedCodes && user.usedCodes.includes(code)) {
        return alert("Error: Kode ini sudah pernah digunakan!");
    }

    try {
        // 2. Decode kode untuk melihat isinya
        const decodedCode = atob(code);
        const [email, amount, timestamp] = decodedCode.split('|');
        const manaAmount = parseInt(amount);

        // 3. Validasi: Apakah kode ini untuk pemain yang benar?
        if (email !== currentUser) {
            return alert("Error: Kode ini tidak valid untuk akun Anda.");
        }

        // 4. Jika semua valid, tambahkan Mana
        user.mana += manaAmount;
        if (!user.usedCodes) user.usedCodes = []; // Inisialisasi jika belum ada
        user.usedCodes.push(code); // Catat kode ini sebagai "sudah dipakai"

        localStorage.setItem("alchemistData", JSON.stringify(userData));
        updateMana();
        alert(`✅ Berhasil! ${manaAmount} Mana telah ditambahkan ke akun Anda.`);
        document.getElementById("redeemInput").value = ""; // Kosongkan input

    } catch (error) {
        // Jika kode tidak bisa di-decode (format salah)
        alert("Error: Kode redeem tidak valid.");
    }
  }

  // FUNGSI UNTUK CEK LOGIN OTOMATIS SAAT HALAMAN DIBUKA
  window.onload = function() {
    const lastSession = localStorage.getItem("lastAlchemistSession");
    if (lastSession && userData[lastSession]) { 
      currentUser = lastSession;
      loadDashboard();
    }
  };
</script>
</body>
</html>
